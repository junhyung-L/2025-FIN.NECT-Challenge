<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SubLocal - ì§€ì—­ ì†Œìƒê³µì¸ êµ¬ë… ê²½ì œ í”Œë«í¼</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4338CA;
            --primary-dark-color: #3730A3;
            --secondary-color: #10B981;
            --secondary-dark-color: #059669;
            --accent-color: #F97316;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --bg-light: #F9FAFB;
            --bg-white: #FFFFFF;<
            --border-color: #E5E7EB;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 414px;
            margin: 0 auto;
            background: var(--bg-white);
            height: 100%;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--bg-white);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            flex-shrink: 0;
        }

        .logo { font-size: 24px; font-weight: 700; color: var(--primary-color); cursor: pointer; }
        .logo .local { color: var(--accent-color); }

        .auth-links { display: flex; gap: 12px; font-size: 14px; align-items: center; }
        .auth-links a { color: var(--text-secondary); text-decoration: none; padding: 6px 12px; border-radius: 8px; transition: all 0.3s ease; }
        .auth-links a:hover { background: #F3F4F6; color: var(--primary-color); }

        #consumer-pages {
            flex-grow: 1;
            overflow-y: auto;
            position: relative;
        }

        .bottom-nav {
            position: relative;
            width: 100%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px); 
            border-top: 1px solid var(--border-color);
            display: flex; 
            justify-content: space-around; 
            padding: 8px 0; 
            z-index: 100;
            flex-shrink: 0;
        }

        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px;
            border-radius: 8px; cursor: pointer; transition: all 0.3s ease;
            font-size: 12px; color: var(--text-secondary); width: 64px;
        }
        .nav-item.active { color: var(--primary-color); background: #EEF2FF; }
        .nav-item:hover:not(.active) { background: #F3F4F6; }
        .nav-item svg { width: 24px; height: 24px; }

        .page { display: none; padding: 20px; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page.active { display: block; }

        .card {
            background: var(--bg-white); border-radius: 16px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #F3F4F6; transition: all 0.3s ease;
        }
        .card:hover { box-shadow: 0 6px 20px rgba(0,0,0,0.12); transform: translateY(-4px); }

        .btn {
            padding: 12px 20px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease; font-size: 16px; display: inline-flex; align-items: center; gap: 8px; justify-content: center;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: var(--primary-dark-color); box-shadow: 0 4px 15px rgba(67, 56, 202, 0.2); }
        .btn-secondary { background: var(--secondary-color); color: white; }
        .btn-secondary:hover { background: var(--secondary-dark-color); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2); }
        .btn-outline { background: transparent; color: var(--primary-color); border: 2px solid var(--primary-color); }
        .btn-outline:hover { background: var(--primary-color); color: white; }
        .btn-small { padding: 8px 16px; font-size: 12px; border-radius: 8px; }

        .section-title { font-size: 22px; font-weight: 700; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .more-link { font-size: 14px; color: var(--text-secondary); text-decoration: none; }
        .more-link:hover { color: var(--primary-color); }

        .subscription-item { display: flex; align-items: center; gap: 16px; padding: 16px; background: #F9FAFB; border-radius: 12px; margin-bottom: 12px; cursor: pointer; }
        .subscription-icon { width: 52px; height: 52px; background: var(--primary-color); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; }
        .subscription-info { flex: 1; }
        .subscription-name { font-weight: 600; }
        .subscription-price { color: var(--text-secondary); font-size: 14px; }
        
        /* ì ì£¼ ì•± (ë‹¤í¬ ëª¨ë“œ) */
        .owner-app { background: #111827; color: #E5E7EB; height: 100%; display: flex; flex-direction: column;}
        .owner-app .header { background: #1F2937; border-bottom-color: #374151; }
        .owner-app .logo { color: var(--secondary-color); }
        .owner-app .logo .local { color: var(--accent-color); }
        .owner-app .card { background: #1F2937; border-color: #374151; }
        .owner-app .btn-primary { background: var(--secondary-color); }
        .owner-app .btn-primary:hover { background: var(--secondary-dark-color); }
        .owner-app .btn-secondary { background: var(--primary-color); }
        .owner-app .btn-secondary:hover { background: var(--primary-dark-color); }
        .owner-app .form-input { background: #374151; border: 1px solid #4B5563; color: white; }
        .owner-app .form-input:focus { border-color: var(--secondary-color); }
        .owner-app .activity-item { padding: 12px 0; border-bottom: 1px solid #4B5563; }
        .owner-app .activity-item:last-child { border-bottom: none; }
        .owner-app .activity-time { font-size: 12px; color: #9CA3AF; }

        /* ëª¨ë‹¬ */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            display: none; align-items: center; justify-content: center; z-index: 1000;
            backdrop-filter: blur(5px); animation: fadeInModal 0.3s ease;
        }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOutModal { from { opacity: 1; } to { opacity: 0; } }
        .modal.fade-out { animation: fadeOutModal 0.3s ease forwards; }
        .modal.show { display: flex; }
        .modal-content {
            background: white; border-radius: 20px; padding: 24px; width: 90%;
            max-width: 380px; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); animation: slideInUp 0.4s ease;
        }
        @keyframes slideInUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .owner-app .modal-content { background: #1F2937; color: #E5E7EB; }
        .modal-title { font-size: 20px; font-weight: 700; margin-bottom: 24px; text-align: center; }
        .modal-close {
            position: absolute; top: 16px; right: 16px; background: #E5E7EB; border: none;
            width: 32px; height: 32px; border-radius: 50%; font-size: 18px; cursor: pointer;
            color: var(--text-secondary); display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
        }
        .modal-close:hover { background: #D1D5DB; transform: rotate(90deg); }

        /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none;}
        .toast {
            background-color: var(--text-primary); color: white; padding: 15px 20px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px;
            opacity: 0; transform: translateX(100%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { background-color: var(--secondary-color); }
        .toast.error { background-color: #EF4444; }

        /* ì´ë¯¸ì§€ ì—…ë¡œë“œ */
        .image-uploader {
            width: 100%; height: 150px; border: 2px dashed var(--border-color); border-radius: 12px;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            cursor: pointer; margin-bottom: 16px; background-color: var(--bg-light);
            transition: all 0.3s ease; overflow: hidden;
        }
        .image-uploader:hover { border-color: var(--primary-color); }
        .owner-app .image-uploader { background-color: #374151; border-color: #4B5563; }
        .owner-app .image-uploader:hover { border-color: var(--secondary-color); }
        .image-uploader img { width: 100%; height: 100%; object-fit: cover; }
        
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; }
        .form-input {
            width: 100%; padding: 12px 16px; border: 1px solid var(--border-color);
            border-radius: 8px; background: var(--bg-light); color: var(--text-primary); font-size: 16px;
        }
        .form-input:focus { outline: none; border-color: var(--primary-color); }

        .hidden { display: none !important; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ì§€ë„ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .map-container { position: relative; width: 100%; height: 75vh; background: #E5E7EB; border-radius: 16px; overflow: hidden; }
        .map-pin {
            position: absolute; width: 32px; height: 32px; background: var(--primary-color);
            border-radius: 50% 50% 50% 0; transform: rotate(-45deg); cursor: pointer;
            display: flex; align-items: center; justify-content: center; color: white;
            font-size: 16px; transition: all 0.2s;
        }
        .map-pin:hover { transform: rotate(-45deg) scale(1.2); }
        .map-pin::before { content: 'ğŸ“'; transform: rotate(45deg); }
        .map-info {
            position: absolute; background: white; padding: 12px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; min-width: 200px;
            z-index: 10;
        }
        .map-info.show { display: block; }
        .map-filters { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 8px; }
        .filter-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border-color); background: var(--bg-white); cursor: pointer; white-space: nowrap; }
        .filter-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        
        /* ì¶”ì²œ ê´‘ê³  ìºëŸ¬ì…€ */
        .carousel { position: relative; height: 120px; border-radius: 16px; overflow: hidden; margin-bottom: 24px; }
        .carousel-slide {
            position: absolute; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark-color));
            display: flex; align-items: center; justify-content: center; color: white;
            font-size: 18px; font-weight: 500; opacity: 0; transition: opacity 0.5s;
        }
        .carousel-slide.active { opacity: 1; }
        .ad-badge { background: var(--secondary-color); color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; margin-left: auto; }

        /* ì ì£¼ ëŒ€ì‹œë³´ë“œ ìŠ¤í¬ë¡¤ ë ˆì´ì•„ì›ƒ */
        .owner-dashboard-layout { display: flex; flex-direction: column; height: 100%; }
        .owner-dashboard-layout .header { flex-shrink: 0; }
        .owner-dashboard-layout .content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .owner-dashboard-layout .footer { flex-shrink: 0; padding: 20px; background: #1F2937; border-top: 1px solid #374151;}

        /* AI ì±—ë´‡ ìŠ¤íƒ€ì¼ */
        #ai-chatbot-fab {
            position: fixed;
            bottom: 80px; /* bottom-nav height + margin */
            left: 50%;
            transform: translateX(calc(207px - 100% - 20px)); /* (container_width / 2) - fab_width - margin */
            width: 50px;
            height: 50px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 999;
            transition: transform 0.3s ease;
        }
        #ai-chatbot-fab:hover { transform: translateX(calc(207px - 100% - 20px)) scale(1.1); }
        .chatbot-messages { height: 300px; overflow-y: auto; margin-bottom: 16px; padding: 10px; background: var(--bg-light); border-radius: 12px; }
        .chat-message { margin-bottom: 12px; display: flex; }
        .chat-message.user { justify-content: flex-end; }
        .chat-message .bubble { padding: 10px 15px; border-radius: 18px; max-width: 80%; }
        .chat-message.user .bubble { background: var(--primary-color); color: white; }
        .chat-message.bot .bubble { background: #E5E7EB; color: var(--text-primary); }
        .chatbot-input-form { display: flex; gap: 8px; }
        .chatbot-input-form input { flex-grow: 1; }

    </style>
</head>
<body>
    <div id="toast-container"></div>

    <div class="container" id="app">
        <!-- ì†Œë¹„ì ì•± -->
        <div id="consumer-app" style="display: flex; flex-direction: column; height: 100%;">
            <div class="header">
                <div class="logo" onclick="goToHome()">Sub<span class="local">Local</span></div>
                <div class="auth-links" id="auth-links-consumer"></div>
            </div>

            <div id="consumer-pages">
                <div class="page active" id="home-page"></div>
                <div class="page" id="map-page"></div>
                <div class="page" id="recommend-page"></div>
                <div class="page" id="settings-page"></div>
            </div>
            
            <div id="ai-chatbot-fab" onclick="showAIChatbotModal()">ğŸ’¬</div>

            <div class="bottom-nav">
                <div class="nav-item active" onclick="switchPage(event, 'home')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><div>í™ˆ</div></div>
                <div class="nav-item" onclick="switchPage(event, 'map')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg><div>ì§€ë„</div></div>
                <div class="nav-item" onclick="switchPage(event, 'recommend')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg><div>ì¶”ì²œ</div></div>
                <div class="nav-item" onclick="switchPage(event, 'settings')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg><div>ì„¤ì •</div></div>
            </div>
        </div>

        <!-- ì ì£¼ ì•± -->
        <div id="owner-app" class="owner-app hidden">
             <!-- ì´ ë‚´ë¶€ëŠ” renderOwnerLoginPageì™€ renderOwnerDashboard í•¨ìˆ˜ë¡œ ë™ì  ìƒì„±ë©ë‹ˆë‹¤ -->
        </div>

        <!-- ëª¨ë‹¬ ì»¨í…Œì´ë„ˆ -->
        <div id="modal-container"></div>
    </div>

    <script>
        // --- ì „ì—­ ìƒíƒœ ë° ë°ì´í„° ---
        let state = {
            currentMode: 'consumer',
            currentPage: 'home',
            loggedInUser: null,
            loggedInOwner: null,
            products: [
                { id: 'prod001', ownerId: 'owner01', name: 'ë§¤ì¼ ì•„ë©”ë¦¬ì¹´ë…¸', store: 'ì—´ì • ì¹´í˜', icon: 'â˜•ï¸', description: 'ì‹ ì„ í•œ ì›ë‘ë¡œ ë§¤ì¼ ë‚´ë ¤ë“œë¦¬ëŠ” ì •ì„± ê°€ë“í•œ ì»¤í”¼. í•˜ë£¨ë¥¼ í™œê¸°ì°¨ê²Œ ì‹œì‘í•˜ì„¸ìš”!', price: 55000, savings: 5000, frequency: 12, image: 'https://images.unsplash.com/photo-1559496417-e7f25cb247f3?q=80&w=3464&auto=format&fit=crop', tags: ['ì¹´í˜'], isAd: true, appliedCurrencyId: 'lc001' },
                { id: 'prod002', ownerId: 'owner01', name: 'ì›” ì„¸íƒ ì„œë¹„ìŠ¤', store: 'ê¹”ë” ì„¸íƒì†Œ', icon: 'ğŸ‘”', description: 'ì™€ì´ì…”ì¸ , ë¸”ë¼ìš°ìŠ¤ ë“± ë§¤ì›” 5ë²Œê¹Œì§€! ë‹¤ë¦¼ì§ˆê¹Œì§€ ì™„ë²½í•˜ê²Œ í•´ë“œë¦½ë‹ˆë‹¤.', price: 30000, savings: 15000, frequency: 1, image: 'https://imgur.com/gmwLmQt.jpg', tags: ['ì„œë¹„ìŠ¤'], appliedCurrencyId: null },
                { id: 'prod003', ownerId: 'owner01', name: 'ìˆ˜ì œ ë² ì´ê¸€ ìƒŒë“œìœ„ì¹˜', store: 'ë§›ìˆëŠ” ë² ì´ì»¤ë¦¬', icon: 'ğŸ¥¯', description: 'ë§¤ì¼ ì•„ì¹¨ êµ¬ìš´ ì«„ê¹ƒí•œ ë² ì´ê¸€ê³¼ ì‹ ì„ í•œ ì¬ë£Œë¡œ ë§Œë“  ìƒŒë“œìœ„ì¹˜ì…ë‹ˆë‹¤.', price: 30000, savings: 8000, frequency: 5, image: 'https://imgur.com/VEuGcyn.jpg', tags: ['ìŒì‹ì '], isAd: true, appliedCurrencyId: 'lc001' },
                { id: 'prod004', ownerId: 'owner01', name: 'ê±´ê°• ìƒëŸ¬ë“œ', store: 'í”„ë ˆì‹œ ê°€ë“ ', icon: 'ğŸ¥—', description: 'ì‹ ì„ í•œ ì±„ì†Œì™€ ë‹­ê°€ìŠ´ì‚´ë¡œ ë§Œë“  ê±´ê°•í•œ ìƒëŸ¬ë“œì…ë‹ˆë‹¤. ì£¼ 3íšŒ ë°°ì†¡!', price: 72000, savings: 4000, frequency: 12, image: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?q=80&w=3540&auto=format&fit=crop', tags: ['ìŒì‹ì '], appliedCurrencyId: null },
                { id: 'prod005', ownerId: 'owner01', name: 'ë“ ë“  ì„¸ì°¨', store: 'ì„¸ì°¨ê¶Œ 2íšŒ', icon: 'ğŸš—', description: 'ë§¤ì›” 2íšŒì”© ë‚´ ì°¨ë¥¼ ê¹”ë”í•˜ê²Œ ê´€ë¦¬í•˜ì„¸ìš”', price: 50000, savings: 7000, frequency: 2, image: 'https://imgur.com/9xmSI6N.jpg', tags: ['ì„œë¹„ìŠ¤'], appliedCurrencyId: 'lc002' }
            ],
            users: {
                'consumer01': { name: 'ê¹€ì†Œë¹„', regularScore: 1250, subscriptions: [{ productId: 'prod001', status: 'active', reservation: null }, { productId: 'prod003', status: 'paused', reservation: null }] },
            },
            owners: {
                'owner01': { 
                    name: 'ë°•ì‚¬ì¥', 
                    storeName: 'ì—´ì • ì¹´í˜', 
                    stats: { subscribers: 127, revenue: 2400000, satisfaction: 94, retentionRate: 88, avgCustomerScore: 850 },
                    localCurrencies: [
                        { id: 'lc001', name: 'ì¸ì²œeìŒ', discountRate: 10 },
                        { id: 'lc002', name: 'ì˜¨ëˆ„ë¦¬ìƒí’ˆê¶Œ', discountRate: 5 }
                    ],
                    activityFeed: [{ text: "ì´ê³ ê°ë‹˜ì´ 'ìˆ˜ì œ ë² ì´ê¸€' êµ¬ë…ì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.", time: new Date(Date.now() - 5 * 60000) }, { text: "ë°•ë‹¨ê³¨ë‹˜ì´ 'ë§¤ì¼ ì•„ë©”ë¦¬ì¹´ë…¸'ë¥¼ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤.", time: new Date(Date.now() - 12 * 60000) }]
                }
            }
        };

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        const $ = (selector) => document.querySelector(selector);
        
        function showToast(message, type = 'info') {
            const container = $('#toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 4000);
        }

        // --- ëª¨ë‹¬ ê´€ë¦¬ ---
        function renderModal(modalId, content, isOwnerModal = false) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            if (isOwnerModal) modal.classList.add('owner-app');
            modal.id = modalId;
            modal.innerHTML = `<div class="modal-content">${content}</div>`;
            $('#modal-container').appendChild(modal);
            modal.addEventListener('click', (event) => { if (event.target === modal) hideModal(modalId); });
            return modal;
        }

        function showModal(modalId, content, isOwnerModal = false) {
            let modal = $(`#${modalId}`);
            if (!modal && content) modal = renderModal(modalId, content, isOwnerModal);
            if (modal) {
                modal.classList.remove('fade-out');
                modal.classList.add('show');
            }
        }

        function hideModal(modalId) {
            const modal = $(`#${modalId}`);
            if (modal) {
                modal.classList.add('fade-out');
                modal.addEventListener('animationend', () => {
                    modal.remove();
                }, { once: true });
            }
        }

        // --- í˜ì´ì§€ ë° ëª¨ë“œ ì „í™˜ ---
        function switchPage(event, pageName) {
            document.querySelectorAll('#consumer-app .page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            $(`#${pageName}-page`).classList.add('active');
            if (event) event.currentTarget.classList.add('active');
            else $(`.nav-item[onclick*="'${pageName}'"]`).classList.add('active');
            
            state.currentPage = pageName;
            renderCurrentPage();
        }

        function toggleOwnerMode() {
            if (state.currentMode === 'consumer') {
                state.currentMode = 'owner';
                $('#consumer-app').classList.add('hidden');
                $('#owner-app').classList.remove('hidden');
                renderCurrentPage();
            }
        }

        function switchToConsumer() {
            state.currentMode = 'consumer';
            $('#owner-app').classList.add('hidden');
            $('#consumer-app').classList.remove('hidden');
            const toggle = $('#owner-toggle');
            if(toggle) toggle.classList.remove('active');
            switchPage(null, 'home');
        }
        
        function goToHome() { switchPage(null, 'home'); }

        // --- ë Œë”ë§ í•¨ìˆ˜ ---
        function renderCurrentPage() {
            if (state.currentMode === 'consumer') {
                switch(state.currentPage) {
                    case 'home': renderHomePage(); break;
                    case 'map': renderMapPage(); break;
                    case 'recommend': renderRecommendPage(); break;
                    case 'settings': renderSettingsPage(); break;
                }
            } else {
                if (!state.loggedInOwner) renderOwnerLoginPage();
                else renderOwnerDashboard();
            }
        }
        
        function renderHomePage() {
            const user = state.users[state.loggedInUser];
            let greetingHTML = `<div style="font-size: 24px; font-weight: 700; margin-bottom: 32px; line-height: 1.4;">ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹<br>ìš°ë¦¬ ë™ë„¤ì˜ ë©‹ì§„ ê°€ê²Œë“¤ì„&nbsp;ë§Œë‚˜ë³´ì„¸ìš”.</div>`;
            let pickupCardHTML = `
                <div class="card" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark-color)); color: white; text-align: center;">
                    <h3 style="font-size: 22px; margin-bottom: 12px; font-weight: 700;">ë¡œê·¸ì¸í•˜ê³  ë‚´ êµ¬ë… ê´€ë¦¬í•˜ê¸°</h3>
                    <p>ë‚˜ë§Œì˜ ë‹¨ê³¨ ê°€ê²Œë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
                    <button class="btn" style="background: rgba(255,255,255,0.2); color: white; margin-top: 20px;" onclick="showLoginModal()">ë¡œê·¸ì¸</button>
                </div>`;

            if (user) {
                greetingHTML = `<div style="font-size: 24px; font-weight: 700; margin-bottom: 32px; line-height: 1.4;">ì•ˆë…•í•˜ì„¸ìš”, <span style="color: var(--accent-color);">${user.name}</span>ë‹˜! ğŸ‘‹<br>ì˜¤ëŠ˜ì€ ì–´ë–¤ ë‹¨ê³¨ ê°€ê²Œì—&nbsp;ë“¤ëŸ¬ë³¼ê¹Œìš”?</div>`;
                const activeSub = user.subscriptions.find(s => s.status === 'active');
                if (activeSub) {
                    const product = state.products.find(p => p.id === activeSub.productId);
                    let pickupText = `ì˜¤ëŠ˜ë„ í”½ì—…í•  ì‹œê°„! <br><span style="color: #FEF3C7; font-weight: 600;"> ì´ë²ˆë‹¬ ${product.savings.toLocaleString()}ì› ì ˆì•½ ì¤‘ğŸ’°</span>`;
                    if(activeSub.reservation) {
                        pickupText = `${activeSub.reservation}ì— ë§Œë‚˜ìš”!`;
                    }
                    
                    pickupCardHTML = `
                        <div class="card" style="
                            background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url(${product.image});
                            background-size: cover;
                            background-position: center;
                            color: white; padding: 24px; padding-bottom: 70px; position: relative;
                        ">
                            <div style="text-align: right; opacity: 0.8; font-size: 12px; font-weight: 500;">${product.store}</div>
                            <h3 style="font-size: 28px; margin-bottom: 16px; font-weight: 700; text-shadow: 1px 1px 3px rgba(0,0,0,0.5);">${product.name}</h3>
                            <p style="font-size: 16px; font-weight: 500;">${pickupText}</p>
                            <div style="position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%);">
                                <button class="btn" style="background: white; color: var(--primary-dark-color); width: 120px; height: 50px; border-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);" onclick="showPickupOptions('${product.id}')">ì§€ê¸ˆ ë°›ê¸°</button>
                            </div>
                        </div>`;
                } else {
                     pickupCardHTML = `
                        <div class="card" style="background: linear-gradient(135deg, var(--secondary-color), var(--secondary-dark-color)); color: white; text-align: center;">
                            <h3 style="font-size: 22px; margin-bottom: 12px; font-weight: 700;">ì²« êµ¬ë…ì„ ì‹œì‘í•´ë³´ì„¸ìš”!</h3>
                            <p>ìš°ë¦¬ ë™ë„¤ì˜ ë©‹ì§„ ê°€ê²Œë“¤ì´ ë‹¹ì‹ ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.</p>
                            <button class="btn" style="background: rgba(255,255,255,0.2); color: white; margin-top: 20px;" onclick="switchPage(event, 'recommend')">ì¶”ì²œ ë³´ëŸ¬ê°€ê¸°</button>
                        </div>`;
                }
            }

            $('#home-page').innerHTML = `
                ${greetingHTML}
                ${pickupCardHTML}
                <div class="section-title">ë‚´ êµ¬ë… <a href="#" class="more-link" onclick="showAllSubscriptions()">ë”ë³´ê¸°</a></div>
                ${(user && user.subscriptions.length > 0) ? user.subscriptions.slice(0, 2).map(sub => {
                    const p = state.products.find(prod => prod.id === sub.productId);
                    return `<div class="subscription-item" onclick="showProductDetail('${p.id}')">
                                <div class="subscription-icon" style="background-image: url(${p.image}); background-size: cover; border-radius: 12px;"></div>
                                <div class="subscription-info"><div class="subscription-name">${p.name}</div><div class="subscription-price">${p.store}</div></div>
                            </div>`;
                }).join('') : '<p class="card">êµ¬ë…ì¤‘ì¸ ìƒí’ˆì´ ì—†ì–´ìš”.</p>'}
                <div class="section-title">ì¶”ì²œ ê°€ê²Œ <a href="#" class="more-link" onclick="switchPage(event, 'recommend')">ë”ë³´ê¸°</a></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    ${state.products.slice(0, 2).map(p => `
                        <div class="card" style="padding: 0; overflow: hidden;" onclick="showProductDetail('${p.id}')">
                            <img src="${p.image}" style="width: 100%; height: 100px; object-fit: cover;">
                            <div style="padding: 16px; text-align: center; font-weight: 600;">${p.store}</div>
                        </div>`).join('')}
                </div>`;
        }

        function renderMapPage(filterTag = 'All') {
            const pins = [
                { id: 'prod001', top: '30%', left: '25%', name: 'ì—´ì • ì¹´í˜', product: 'ë§¤ì¼ ì•„ë©”ë¦¬ì¹´ë…¸', tag: 'ì¹´í˜' },
                { id: 'prod002', top: '50%', left: '60%', name: 'ê¹”ë” ì„¸íƒì†Œ', product: 'ì›” ì„¸íƒ ì„œë¹„ìŠ¤', tag: 'ì„œë¹„ìŠ¤' },
                { id: 'prod003', top: '70%', left: '35%', name: 'ë§›ìˆëŠ” ë² ì´ì»¤ë¦¬', product: 'ìˆ˜ì œ ë² ì´ê¸€', tag: 'ìŒì‹ì ' },
                { id: 'prod004', top: '20%', left: '70%', name: 'í”„ë ˆì‹œ ê°€ë“ ', product: 'ê±´ê°• ìƒëŸ¬ë“œ', tag: 'ìŒì‹ì ' },
                { id: 'prod005', top: '60%', left: '15%', name: 'ë“ ë“  ì„¸ì°¨', product: 'ì„¸ì°¨ê¶Œ 2íšŒ', tag: 'ì„œë¹„ìŠ¤' }
            ];

            const filteredPins = (filterTag === 'All') ? pins : pins.filter(p => p.tag === filterTag);
            const pinsHTML = filteredPins.map(p => `<div class="map-pin" style="top: ${p.top}; left: ${p.left};" onclick="showMapInfo(this, '${p.name}', '${p.product}', '${p.id}')"></div>`).join('');

            $('#map-page').innerHTML = `
                <h2 style="margin-bottom: 20px;">ë‚´ ì£¼ë³€ ê°€ê²Œ</h2>
                <div class="map-filters">
                    <button class="filter-btn ${filterTag === 'All' ? 'active' : ''}" onclick="renderMapPage('All')">ì „ì²´</button>
                    <button class="filter-btn ${filterTag === 'ì¹´í˜' ? 'active' : ''}" onclick="renderMapPage('ì¹´í˜')">â˜•ï¸ ì¹´í˜</button>
                    <button class="filter-btn ${filterTag === 'ìŒì‹ì ' ? 'active' : ''}" onclick="renderMapPage('ìŒì‹ì ')">ğŸ½ï¸ ìŒì‹ì </button>
                    <button class="filter-btn ${filterTag === 'ì„œë¹„ìŠ¤' ? 'active' : ''}" onclick="renderMapPage('ì„œë¹„ìŠ¤')">âœ¨ ì„œë¹„ìŠ¤</button>
                </div>
                <div class="map-container card">
                    <img src="https://imgur.com/p9qKw57.jpg" style="width:100%; height:100%; object-fit: cover;">
                    ${pinsHTML}
                    <div class="map-info" id="map-info-popup"></div>
                </div>`;
        }

        function renderRecommendPage() {
            $('#recommend-page').innerHTML = `
                <div class="carousel">
                    <div class="carousel-slide active">ğŸ¯ ì´ë²ˆ ì£¼ íŠ¹ê°€ êµ¬ë…!</div>
                    <div class="carousel-slide">ğŸ”¥ ì‹ ê·œ ê°€ê²Œ ì˜¤í”ˆ ì´ë²¤íŠ¸</div>
                    <div class="carousel-slide">ğŸ’ ì¹œêµ¬ ì¶”ì²œí•˜ê³  í• ì¸ë°›ê¸°</div>
                </div>
                <h3 style="margin-bottom: 16px;">ìš°ë¦¬ ë™ë„¤ ì¸ê¸° êµ¬ë… TOP 5</h3>
                <ul style="list-style: none;">
                    ${state.products.map((p, i) => `
                    <li class="card" style="display:flex; align-items: center; gap: 16px;" onclick="showProductDetail('${p.id}')">
                        <div style="background: var(--primary-color); color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: 600; flex-shrink: 0;">${i+1}</div>
                        <img src="${p.image}" alt="${p.name}" style="width: 60px; height: 60px; border-radius: 12px; object-fit: cover;">
                        <div class="subscription-info">
                            <div class="subscription-name">${p.name}</div>
                            <div class="subscription-price">${p.store}</div>
                        </div>
                        ${p.isAd ? '<div class="ad-badge">ê´‘ê³ </div>' : ''}
                    </li>`).join('')}
                </ul>`;
            startCarousel();
        }
        
        function renderSettingsPage() {
            $('#settings-page').innerHTML = `
                <h2 style="margin-bottom: 24px;">ì„¤ì •</h2>
                <div class="card" style="padding: 0;">
                    <ul style="list-style: none;">
                        ${['ì•Œë¦¼ ì„¤ì •', 'ê³„ì • ì •ë³´', 'ê²°ì œ ê´€ë¦¬', 'ê³ ê°ì„¼í„°'].map(item => `<li style="display: flex; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="showToast('${item} ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')"><span>${item}</span><span>></span></li>`).join('')}
                        <li style="display: flex; justify-content: space-between; padding: 16px 20px; cursor: pointer;" onclick="toggleOwnerMode()">
                            <span>ì ì£¼ ëª¨ë“œë¡œ ì „í™˜</span>
                            <div class="toggle-switch" id="owner-toggle"></div>
                        </li>
                    </ul>
                </div>`;
        }
        
        function renderOwnerLoginPage() {
            $('#owner-app').innerHTML = `
                <div class="page active" style="display: flex; align-items: center; justify-content: center; height: 100%;">
                    <div style="max-width: 320px; width: 100%;">
                        <h2 style="text-align: center; font-size: 24px; font-weight: 700; margin-bottom: 32px; color: var(--secondary-color);">ì ì£¼ ë¡œê·¸ì¸</h2>
                        <div class="form-group"><label class="form-label">ì•„ì´ë””</label><input type="text" class="form-input" id="owner-id-input" value="owner01"></div>
                        <div class="form-group"><label class="form-label">ë¹„ë°€ë²ˆí˜¸</label><input type="password" class="form-input" id="owner-password-input" value="password123"></div>
                        <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="ownerLogin()">ë¡œê·¸ì¸</button>
                        <div style="text-align: center; margin-top: 20px;"><a href="#" style="color: var(--secondary-color);" onclick="switchToConsumer()">ì†Œë¹„ì ëª¨ë“œë¡œ ì „í™˜</a></div>
                    </div>
                </div>`;
        }

        function renderOwnerDashboard() {
            const owner = state.owners[state.loggedInOwner];
            if (!owner) return;
            
            const productsHTML = state.products.filter(p => p.ownerId === state.loggedInOwner).map(p => `
                <div class="subscription-item" style="background: #374151; border: 1px solid #4B5563;">
                    <div class="subscription-icon" style="background-image: url(${p.image}); background-size: cover; border-radius: 12px;"></div>
                    <div class="subscription-info"><div class="subscription-name" style="color: white;">${p.name}</div><div class="subscription-price" style="color: #9CA3AF;">ì›” ${p.price.toLocaleString()}ì›</div></div>
                    <button class="btn btn-outline btn-small" style="color: var(--secondary-color); border-color: var(--secondary-color);" onclick="showProductForm('${p.id}')">ìˆ˜ì •</button>
                </div>`).join('');

            const activityFeedHTML = owner.activityFeed.sort((a,b) => b.time - a.time).map(item => `<div class="activity-item"><div>${item.text}</div><div class="activity-time">${new Date(item.time).toLocaleString('ko-KR')}</div></div>`).join('');

            const score = calculateOwnerScore(owner);

            $('#owner-app').innerHTML = `
                <div class="owner-dashboard-layout">
                    <div class="header"><div class="logo">Sub<span class="local">Local</span> ì ì£¼</div><a href="#" style="color: var(--secondary-color);" onclick="switchToConsumer()">ì†Œë¹„ì ëª¨ë“œ</a></div>
                    <div class="content">
                        <h2 style="margin-bottom: 20px;">ëŒ€ì‹œë³´ë“œ</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                            <div class="card" style="padding: 20px; text-align: center; margin: 0; cursor: pointer;" onclick="showScoreDetailModal()">
                                <div style="font-size: 24px; font-weight: 700; color: var(--secondary-color);">${score}</div>
                                <div style="font-size: 14px; color: #9CA3AF;">êµ¬ë… ìì‚° ìŠ¤ì½”ì–´</div>
                            </div>
                            <div class="card" style="padding: 20px; text-align: center; margin: 0;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--secondary-color);">${owner.stats.subscribers}</div>
                                <div style="font-size: 14px; color: #9CA3AF;">êµ¬ë…ì ìˆ˜</div>
                            </div>
                            <div class="card" style="padding: 20px; text-align: center; margin: 0;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--secondary-color);">${(owner.stats.revenue/1000000).toFixed(1)}M</div>
                                <div style="font-size: 14px; color: #9CA3AF;">ì›” ë§¤ì¶œ</div>
                            </div>
                             <div class="card" style="padding: 20px; text-align: center; margin: 0;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--secondary-color);">${owner.stats.satisfaction}%</div>
                                <div style="font-size: 14px; color: #9CA3AF;">ë§Œì¡±ë„</div>
                            </div>
                        </div>
                        <div class="card"><h3 style="margin-bottom: 16px;">ìš´ì˜ ì¤‘ì¸ êµ¬ë… ìƒí’ˆ</h3><div id="owner-products">${productsHTML || '<p>ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>'}</div></div>
                        <div class="card"><h3 style="margin-bottom: 16px;">ì‹¤ì‹œê°„ ì£¼ë¬¸ ì•Œë¦¼</h3><div id="activity-feed">${activityFeedHTML}</div></div>
                    </div>
                    <div class="footer">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <button class="btn btn-primary" onclick="showProductForm()">ìƒˆ ìƒí’ˆ ë§Œë“¤ê¸°</button>
                            <button class="btn btn-secondary" onclick="showBenefitsManager()">í˜œíƒ ê´€ë¦¬</button>
                        </div>
                    </div>
                </div>`;
        }

        // --- ê¸°ëŠ¥ í•¨ìˆ˜ ---
        function completeLogin() {
            const userId = $('#login-id-input').value;
            if (state.users[userId]) {
                state.loggedInUser = userId;
                hideModal('loginModal');
                showToast(`í™˜ì˜í•©ë‹ˆë‹¤, ${state.users[userId].name}ë‹˜!`, 'success');
                renderAuthLinks();
                renderHomePage();
            } else { showToast('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤.', 'error'); }
        }

        function ownerLogin() {
            const ownerId = $('#owner-id-input').value;
            if (state.owners[ownerId]) {
                state.loggedInOwner = ownerId;
                renderOwnerDashboard();
                showToast(`${state.owners[ownerId].storeName} ì ì£¼ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`, 'success');
            } else { showToast('ì ì£¼ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error'); }
        }
        
        function showProductDetail(productId) {
            const product = state.products.find(p => p.id === productId);
            if (!product) return;
            
            let discountInfo = '';
            if (product.appliedCurrencyId && product.ownerId) {
                const owner = state.owners[product.ownerId];
                if (owner && owner.localCurrencies) {
                    const currency = owner.localCurrencies.find(c => c.id === product.appliedCurrencyId);
                    if (currency) {
                        discountInfo = `<div class="card" style="background-color: #E0F2F1; text-align: center; margin-top: 16px;"><p style="color: var(--secondary-dark-color); font-weight: 600;">ğŸ’° ${currency.name}ìœ¼ë¡œ ê²°ì œ ì‹œ ${currency.discountRate}% ì¶”ê°€ í• ì¸!</p></div>`;
                    }
                }
            }

            const content = `<button class="modal-close" onclick="hideModal('productDetailModal')">&times;</button><img src="${product.image}" alt="${product.name}" style="width: 100%; height: 180px; border-radius: 16px; object-fit: cover; margin-bottom: 20px;"><h3 class="modal-title" style="text-align: left; margin-bottom: 8px;">${product.name}</h3><p style="color: var(--text-secondary); margin-bottom: 16px;">${product.store}</p><p style="margin-bottom: 24px;">${product.description}</p><div class="card" style="background-color: var(--bg-light);"><h4 style="margin-bottom: 8px;">ì›” ${product.price.toLocaleString()}ì›</h4><p style="color: var(--text-secondary);">ë§¤ì›” ${product.frequency}íšŒ ì œê³µ</p></div>${discountInfo}<button class="btn btn-secondary" style="width: 100%; margin-bottom: 12px;" onclick="getAIRecommendation('${product.name}')">ğŸ¤– AIì—ê²Œ ë¬¼ì–´ë³´ê¸°</button><button class="btn btn-primary" style="width: 100%;" onclick="completeSubscription('${product.id}')">ì´ ìƒí’ˆ êµ¬ë…í•˜ê¸°</button>`;
            showModal('productDetailModal', content);
        }

        function completeSubscription(productId) {
            if (!state.loggedInUser) { showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error'); showLoginModal(); return; }
            const user = state.users[state.loggedInUser];
            if (user.subscriptions.some(s => s.productId === productId)) { showToast('ì´ë¯¸ êµ¬ë… ì¤‘ì¸ ìƒí’ˆì…ë‹ˆë‹¤.'); return; }
            user.subscriptions.push({ productId, status: 'active' });
            hideModal('productDetailModal');
            showToast('êµ¬ë…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            const product = state.products.find(p => p.id === productId);
            addActivityFeed(product.ownerId, `${user.name}ë‹˜ì´ '${product.name}' êµ¬ë…ì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.`);
            renderCurrentPage();
        }
        
        function showAllSubscriptions() {
            if (!state.loggedInUser) { showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error'); showLoginModal(); return; }
            const user = state.users[state.loggedInUser];
            const subsHTML = user.subscriptions.map(sub => {
                const product = state.products.find(p => p.id === sub.productId);
                const isActive = sub.status === 'active';
                return `<div class="subscription-item" style="opacity: ${isActive ? 1 : 0.6};"><div class="subscription-icon" style="background-image: url(${product.image}); background-size: cover; border-radius: 12px;"></div><div class="subscription-info"><div class="subscription-name">${product.name}</div><div class="subscription-price">${product.store}</div><div style="font-size: 12px; color: ${isActive ? 'var(--secondary-color)' : 'var(--text-secondary)'}; margin-top: 4px;">${isActive ? 'í™œì„± êµ¬ë…' : 'ì¼ì‹œì •ì§€'}</div></div><div style="display: flex; flex-direction: column; gap: 8px;">${isActive ? `<button class="btn btn-outline btn-small" onclick="showGiftModal('${sub.productId}')">ì„ ë¬¼</button><button class="btn btn-outline btn-small" onclick="showTransferModal('${sub.productId}')">ì–‘ë„</button><button class="btn btn-outline btn-small" onclick="pauseSubscription('${sub.productId}')">ì •ì§€</button>` : `<button class="btn btn-primary btn-small" onclick="resumeSubscription('${sub.productId}')">ì¬ê°œ</button>`}</div></div>`;
            }).join('');
            const content = `<button class="modal-close" onclick="hideModal('allSubscriptionsModal')">&times;</button><h3 class="modal-title">ë‚´ ëª¨ë“  êµ¬ë…</h3>${subsHTML || '<p>êµ¬ë… ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>'}<button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="hideModal('allSubscriptionsModal'); switchPage(null, 'recommend');">ìƒˆ êµ¬ë… ì°¾ê¸°</button>`;
            showModal('allSubscriptionsModal', content);
        }

        function pauseSubscription(productId) {
            const sub = state.users[state.loggedInUser].subscriptions.find(s => s.productId === productId);
            if (sub) sub.status = 'paused';
            showToast('êµ¬ë…ì´ ì¼ì‹œì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            hideModal('allSubscriptionsModal');
            showAllSubscriptions();
            renderCurrentPage();
        }
        
        function resumeSubscription(productId) {
            const sub = state.users[state.loggedInUser].subscriptions.find(s => s.productId === productId);
            if (sub) sub.status = 'active';
            showToast('êµ¬ë…ì„ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤!', 'success');
            hideModal('allSubscriptionsModal');
            showAllSubscriptions();
            renderCurrentPage();
        }

        function addActivityFeed(ownerId, message) {
            const owner = state.owners[ownerId];
            if (owner) {
                owner.activityFeed.unshift({ text: message, time: new Date() });
                if (state.currentMode === 'owner' && state.loggedInOwner === ownerId) renderOwnerDashboard();
            }
        }

        function showPickupOptions(productId) {
            const content = `<button class="modal-close" onclick="hideModal('pickupOptionsModal')">&times;</button><h3 class="modal-title">í”½ì—… ë°©ë²• ì„ íƒ</h3><button class="btn btn-primary" style="width: 100%; margin-bottom: 12px;" onclick="pickupNow('${productId}')">ì§€ê¸ˆ ë°›ê¸° (QR)</button><button class="btn btn-outline" style="width: 100%;" onclick="showTimeReservation('${productId}')">ë‚˜ì¤‘ì— ë°›ê¸°</button>`;
            showModal('pickupOptionsModal', content);
        }
        
        function pickupNow(productId) {
            hideModal('pickupOptionsModal');
            const qrContent = `<button class="modal-close" onclick="hideModal('qrModal')">&times;</button><h3 class="modal-title">QR ì½”ë“œë¡œ í”½ì—…í•˜ê¸°</h3><div style="text-align: center; margin: 20px 0;"><img src="https://imgur.com/ESSU0dQ.jpg" alt="QR Code" style="width: 200px; height: 200px; border-radius: 12px;"><p style="margin-top: 16px; color: var(--text-secondary);">ê°€ê²Œì—ì„œ ì´ QR ì½”ë“œë¥¼ ë³´ì—¬ì£¼ì„¸ìš”</p></div>`;
            showModal('qrModal', qrContent);
            const product = state.products.find(p => p.id === productId);
            const user = state.users[state.loggedInUser];
            addActivityFeed(product.ownerId, `${user.name}ë‹˜ì´ '${product.name}'ì„(ë¥¼) ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤.`);
            showToast(`${product.name} í”½ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        function showTimeReservation(productId) {
            hideModal('pickupOptionsModal');
            const content = `<button class="modal-close" onclick="hideModal('timeReservationModal')">&times;</button><h3 class="modal-title">í”½ì—… ì‹œê°„ ì˜ˆì•½</h3><div class="form-group"><label class="form-label">ë‚ ì§œ</label><input type="date" class="form-input" id="pickup-date"></div><div class="form-group"><label class="form-label">ì‹œê°„</label><input type="time" class="form-input" id="pickup-time"></div><button class="btn btn-primary" style="width: 100%;" onclick="confirmReservation('${productId}')">ì˜ˆì•½ ì™„ë£Œ</button>`;
            showModal('timeReservationModal', content);
        }

        function confirmReservation(productId) {
            const timeValue = $('#pickup-time').value;
            if (!timeValue) {
                showToast('ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            const user = state.users[state.loggedInUser];
            const sub = user.subscriptions.find(s => s.productId === productId);
            if (sub) {
                sub.reservation = timeValue;
            }
            hideModal('timeReservationModal');
            showToast('í”½ì—… ì‹œê°„ì´ ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            renderHomePage();
        }

        function showProductForm(productIdToEdit = null) {
            const isEditing = !!productIdToEdit;
            const product = isEditing ? state.products.find(p => p.id === productIdToEdit) : {};
            const owner = state.owners[state.loggedInOwner];
            const currencyOptions = owner.localCurrencies.map(c => `<option value="${c.id}" ${product.appliedCurrencyId === c.id ? 'selected' : ''}>${c.name} (${c.discountRate}%)</option>`).join('');

            const content = `<button class="modal-close" onclick="hideModal('productFormModal')">&times;</button><h3 class="modal-title">${isEditing ? 'ìƒí’ˆ ìˆ˜ì •' : 'ìƒˆ ìƒí’ˆ ë§Œë“¤ê¸°'}</h3><label for="product-image-input" class="image-uploader" id="image-uploader">${isEditing && product.image ? `<img src="${product.image}" id="product-image-preview">` : `<span>ì´ë¯¸ì§€ ì—…ë¡œë“œ</span>`}</label><input type="file" id="product-image-input" class="hidden" accept="image/*"><div class="form-group"><label class="form-label">ìƒí’ˆëª…</label><input type="text" class="form-input" id="product-name" value="${product.name || ''}"></div><div class="form-group"><label class="form-label">ìƒí’ˆ ì„¤ëª…</label><textarea class="form-input" id="product-description" style="height: 80px;">${product.description || ''}</textarea><button type="button" class="btn btn-outline btn-small" style="width:100%; margin-top: 8px;" onclick="generateAIDescription(this)">âœ¨ AIë¡œ ì„¤ëª… ìƒì„±</button></div><div class="form-group"><label class="form-label">ì›” êµ¬ë…ë£Œ (ì›)</label><input type="number" class="form-input" id="product-price" value="${product.price || ''}"></div><div class="form-group"><label class="form-label">ì§€ì—­í™”í í• ì¸ ì ìš©</label><select class="form-input" id="product-currency"><option value="">ì ìš© ì•ˆí•¨</option>${currencyOptions}</select></div><button class="btn btn-primary" style="width: 100%;" onclick="registerProduct('${productIdToEdit || ''}')">${isEditing ? 'ìˆ˜ì • ì™„ë£Œ' : 'ìƒí’ˆ ë“±ë¡'}</button>`;
            showModal('productFormModal', content, true);
            $('#product-image-input').addEventListener('change', (event) => {
                if (event.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => { $('#image-uploader').innerHTML = `<img src="${e.target.result}" id="product-image-preview">`; };
                    reader.readAsDataURL(event.target.files[0]);
                }
            });
        }
        
        function registerProduct(productIdToEdit) {
            const name = $('#product-name').value, price = parseInt($('#product-price').value), description = $('#product-description').value, image = $('#product-image-preview')?.src || 'https://placehold.co/400x300/e2e8f0/64748b?text=No+Image', appliedCurrencyId = $('#product-currency').value || null;
            if (!name || !price) { showToast('ìƒí’ˆëª…ê³¼ ê°€ê²©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
            if (productIdToEdit) {
                Object.assign(state.products.find(p => p.id === productIdToEdit), { name, price, description, image, appliedCurrencyId });
                showToast('ìƒí’ˆ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                state.products.push({ id: 'prod' + Date.now(), ownerId: state.loggedInOwner, store: state.owners[state.loggedInOwner].storeName, icon: 'ğŸ†•', name, price, description, image, frequency: 30, tags: [], appliedCurrencyId });
                showToast('ìƒˆ ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            }
            hideModal('productFormModal');
            renderOwnerDashboard();
        }
        
        function showMapInfo(pin, storeName, product, productId) {
            const infoPopup = $('#map-info-popup');
            infoPopup.innerHTML = `<h4 style="margin-bottom: 8px;">${storeName}</h4><p style="color: var(--text-secondary); font-size: 14px;">${product}</p><button class="btn btn-primary btn-small" style="margin-top: 8px;" onclick="showProductDetail('${productId}')">ìƒì„¸ë³´ê¸°</button>`;
            infoPopup.style.top = (pin.offsetTop + 30) + 'px';
            infoPopup.style.left = (pin.offsetLeft - 80) + 'px';
            infoPopup.classList.add('show');
            setTimeout(() => { infoPopup.classList.remove('show'); }, 4000);
        }

        let carouselInterval;
        function startCarousel() {
            clearInterval(carouselInterval);
            let carouselIndex = 0;
            const slides = document.querySelectorAll('.carousel-slide');
            if(slides.length === 0) return;
            carouselInterval = setInterval(() => {
                if(slides[carouselIndex]) slides[carouselIndex].classList.remove('active');
                carouselIndex = (carouselIndex + 1) % slides.length;
                if(slides[carouselIndex]) slides[carouselIndex].classList.add('active');
            }, 3000);
        }

        // --- Gemini API ê¸°ëŠ¥ ---
        async function callGemini(prompt, buttonElement = null) {
            let originalButtonText;
            if (buttonElement) {
                originalButtonText = buttonElement.innerHTML;
                buttonElement.disabled = true;
                buttonElement.innerHTML = '<div class="loading"></div>';
            }

            const apiKey = ""; // API í‚¤ëŠ” ë¹„ì›Œë‘ì„¸ìš”
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API call failed: ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    return result.candidates[0].content.parts[0].text;
                }
                return "ì£„ì†¡í•©ë‹ˆë‹¤, AI ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showToast('AI ì„œë¹„ìŠ¤ì— ì—°ê²°í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                return null;
            } finally {
                if (buttonElement) {
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = originalButtonText;
                }
            }
        }

        async function getAIRecommendation(productName) {
            const content = `<button class="modal-close" onclick="hideModal('aiRecommendModal')">&times;</button><h3 class="modal-title">ğŸ¤– AI ì¶”ì²œ</h3><div id="ai-recommend-content"><div class="loading" style="margin: 20px auto; display: block;"></div></div>`;
            showModal('aiRecommendModal', content);
            const recommendation = await callGemini(`'${productName}' êµ¬ë… ìƒí’ˆì— ëŒ€í•œ ì§§ê³  ë§¤ë ¥ì ì¸ ì¶”ì²œì‚¬ë¥¼ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì¤˜.`);
            $('#ai-recommend-content').innerHTML = `<p style="line-height: 1.7; text-align: center;">${recommendation}</p>`;
        }

        async function generateAIDescription(buttonElement) {
            const productName = $('#product-name').value;
            if (!productName) {
                showToast('ìƒí’ˆëª…ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            const prompt = `'${productName}'ì´ë¼ëŠ” ìƒí’ˆì— ëŒ€í•œ ë§¤ë ¥ì ì´ê³  ì¹œê·¼í•œ ìƒí’ˆ ì„¤ëª…ì„ í•œêµ­ì–´ë¡œ 100ì ë‚´ì™¸ë¡œ ì‘ì„±í•´ì¤˜.`;
            const description = await callGemini(prompt, buttonElement);
            if (description) {
                $('#product-description').value = description;
                showToast('AI ì„¤ëª…ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            }
        }
        
        async function generateAIGiftMessage(buttonElement, productId) {
            const product = state.products.find(p => p.id === productId);
            const recipientId = $('#gift-id-input').value;
            if (!recipientId) {
                showToast('ì„ ë¬¼ë°›ì„ ì¹œêµ¬ì˜ ì•„ì´ë””ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            const prompt = `'${recipientId}'ë‹˜ì—ê²Œ '${product.name}'(${product.store}) êµ¬ë…ê¶Œì„ ì„ ë¬¼í•˜ë ¤ê³  í•©ë‹ˆë‹¤. ë”°ëœ»í•˜ê³  ì¹œê·¼í•œ ì„ ë¬¼ ë©”ì‹œì§€ë¥¼ í•œêµ­ì–´ë¡œ 50ì ë‚´ì™¸ë¡œ ì‘ì„±í•´ì¤˜.`;
            const message = await callGemini(prompt, buttonElement);
            if (message) {
                $('#gift-message-textarea').value = message;
            }
        }

        // --- ì±—ë´‡ ê¸°ëŠ¥ ---
        let chatHistory = [];
        function showAIChatbotModal() {
            const content = `
                <button class="modal-close" onclick="hideModal('aiChatbotModal')">&times;</button>
                <h3 class="modal-title">AI ì±—ë´‡ 'ì¨ë¹„'</h3>
                <div class="chatbot-messages" id="chatbot-messages">
                    <div class="chat-message bot"><div class="bubble">ì•ˆë…•í•˜ì„¸ìš”! SubLocalì˜ AI ì±—ë´‡ ì¨ë¹„ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div></div>
                </div>
                <form id="chatbot-input-form" class="chatbot-input-form">
                    <input type="text" id="chatbot-input" class="form-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
                    <button type="submit" class="btn btn-primary">ì „ì†¡</button>
                </form>
            `;
            showModal('aiChatbotModal', content);
            $('#chatbot-input-form').addEventListener('submit', handleChatSubmit);
        }

        async function handleChatSubmit(event) {
            event.preventDefault();
            const input = $('#chatbot-input');
            const message = input.value.trim();
            if (!message) return;

            addChatMessage(message, 'user');
            input.value = '';

            const prompt = `You are 'Subby', a friendly and helpful chatbot for the 'SubLocal' app. Your goal is to assist users with their questions about local store subscriptions. You can answer questions about how the app works, recommend products based on user preferences (e.g., coffee, laundry, bakery), and provide general assistance. Keep your answers concise, friendly, and in Korean. Here is the user's question: '${message}'`;
            
            const response = await callGemini(prompt);
            if (response) {
                addChatMessage(response, 'bot');
            }
        }

        function addChatMessage(message, sender) {
            const messageContainer = $('#chatbot-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.innerHTML = `<div class="bubble">${message}</div>`;
            messageContainer.appendChild(messageDiv);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }


        // --- ì¸ì¦ ë° ì´ˆê¸°í™” ---
        function renderAuthLinks() {
            const user = state.users[state.loggedInUser];
            const container = $('#auth-links-consumer');
            if (user) {
                container.innerHTML = `<span style="color: var(--primary-color); font-weight: 600;">${user.name}ë‹˜</span>`;
            } else {
                container.innerHTML = `<a href="#" onclick="showLoginModal()">ë¡œê·¸ì¸</a><a href="#" onclick="showSignupModal()">ê°€ì…</a>`;
            }
        }
        
        function showLoginModal() {
            const content = `<button class="modal-close" onclick="hideModal('loginModal')">&times;</button><h3 class="modal-title">ë¡œê·¸ì¸</h3><div class="form-group"><label class="form-label">ì•„ì´ë””</label><input id="login-id-input" type="text" class="form-input" placeholder="consumer01" value="consumer01"></div><button class="btn btn-primary" style="width: 100%;" onclick="completeLogin()">ë¡œê·¸ì¸</button>`;
            showModal('loginModal', content);
        }

        function showSignupModal() {
            const content = `<button class="modal-close" onclick="hideModal('signupModal')">&times;</button><h3 class="modal-title">íšŒì›ê°€ì…</h3><div class="form-group"><label class="form-label">ì´ë¦„</label><input id="signup-name-input" type="text" class="form-input" placeholder="ì´ë¦„ ì…ë ¥"></div><button class="btn btn-primary" style="width: 100%;" onclick="completeSignup()">ê°€ì…í•˜ê¸°</button>`;
            showModal('signupModal', content);
        }
        
        function completeSignup() {
            const name = $('#signup-name-input').value;
            if(!name) { showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
            const newId = 'user' + Date.now();
            state.users[newId] = { name: name, subscriptions: [], regularScore: 0 };
            state.loggedInUser = newId;
            hideModal('signupModal');
            showToast(`${name}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`, 'success');
            renderAuthLinks();
            renderHomePage();
        }
        
        function showGiftModal(productId) {
            const content = `<button class="modal-close" onclick="hideModal('giftModal')">&times;</button><h3 class="modal-title">êµ¬ë… ì„ ë¬¼í•˜ê¸°</h3><p style="text-align: center; margin-bottom: 16px;">ì„ ë¬¼í•  ì¹œêµ¬ì˜ ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p><div class="form-group"><input id="gift-id-input" type="text" class="form-input" placeholder="ì¹œêµ¬ ì•„ì´ë””"></div><div class="form-group"><label class="form-label">ì„ ë¬¼ ë©”ì‹œì§€</label><textarea id="gift-message-textarea" class="form-input" rows="3"></textarea><button type="button" class="btn btn-outline btn-small" style="width:100%; margin-top: 8px;" onclick="generateAIGiftMessage(this, '${productId}')">âœ¨ AIë¡œ ë©”ì‹œì§€ ì¶”ì²œ</button></div><button class="btn btn-primary" style="width: 100%;" onclick="completeGift('${productId}')">ì„ ë¬¼í•˜ê¸°</button>`;
            showModal('giftModal', content);
        }
        function completeGift(productId) {
            const friendId = $('#gift-id-input').value;
            if (!friendId) { showToast('ì¹œêµ¬ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
            hideModal('giftModal');
            showToast(`${friendId}ë‹˜ì—ê²Œ êµ¬ë…ê¶Œì„ ì„ ë¬¼í–ˆìŠµë‹ˆë‹¤!`, 'success');
        }

        function showTransferModal(productId) {
            const content = `<button class="modal-close" onclick="hideModal('transferModal')">&times;</button><h3 class="modal-title">êµ¬ë… ì–‘ë„í•˜ê¸°</h3><p style="text-align: center; margin-bottom: 16px;">ì–‘ë„ë°›ì„ ë¶„ì˜ ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p><div class="form-group"><input id="transfer-id-input" type="text" class="form-input" placeholder="ì–‘ë„ë°›ì„ ë¶„ ì•„ì´ë””"></div><button class="btn btn-primary" style="width: 100%;" onclick="completeTransfer('${productId}')">ì–‘ë„í•˜ê¸°</button>`;
            showModal('transferModal', content);
        }
        function completeTransfer(productId) {
            const transferId = $('#transfer-id-input').value;
            if (!transferId) { showToast('ì–‘ë„ë°›ì„ ë¶„ì˜ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
            hideModal('transferModal');
            showToast(`${transferId}ë‹˜ì—ê²Œ êµ¬ë…ê¶Œì„ ì–‘ë„í–ˆìŠµë‹ˆë‹¤.`, 'success');
        }
        
        function showBenefitsManager() {
            const owner = state.owners[state.loggedInOwner];
            const currenciesHTML = owner.localCurrencies.map(c => `<div class="subscription-item" style="background: #374151;"><span>${c.name} (${c.discountRate}%)</span><button class="btn btn-outline btn-small" style="color: #EF4444; border-color: #EF4444;" onclick="deleteCurrency('${c.id}')">ì‚­ì œ</button></div>`).join('');
            const content = `<button class="modal-close" onclick="hideModal('benefitsModal')">&times;</button><h3 class="modal-title">í˜œíƒ ê´€ë¦¬</h3><div class="card"><h4 style="margin-bottom: 16px;">ë“±ë¡ëœ ì§€ì—­í™”í</h4>${currenciesHTML || '<p>ë“±ë¡ëœ ì§€ì—­í™”íê°€ ì—†ìŠµë‹ˆë‹¤.</p>'}</div><div class="card"><h4 style="margin-bottom: 16px;">ìƒˆ ì§€ì—­í™”í ì¶”ê°€</h4><div class="form-group"><label class="form-label">í™”í ì´ë¦„</label><input type="text" id="currency-name" class="form-input"></div><div class="form-group"><label class="form-label">í• ì¸ìœ¨ (%)</label><input type="number" id="currency-rate" class="form-input"></div><button class="btn btn-primary" style="width: 100%;" onclick="addCurrency()">ì¶”ê°€í•˜ê¸°</button></div>`;
            showModal('benefitsModal', content, true);
        }

        function addCurrency() {
            const name = $('#currency-name').value;
            const rate = parseInt($('#currency-rate').value);
            if (!name || !rate) { showToast('í™”í ì´ë¦„ê³¼ í• ì¸ìœ¨ì„ ì…ë ¥í•˜ì„¸ìš”.', 'error'); return; }
            state.owners[state.loggedInOwner].localCurrencies.push({ id: 'lc' + Date.now(), name, discountRate: rate });
            hideModal('benefitsModal');
            showBenefitsManager();
            showToast('ìƒˆ ì§€ì—­í™”íê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        function deleteCurrency(currencyId) {
            const owner = state.owners[state.loggedInOwner];
            owner.localCurrencies = owner.localCurrencies.filter(c => c.id !== currencyId);
            hideModal('benefitsModal');
            showBenefitsManager();
            showToast('ì§€ì—­í™”íê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }
        
        // --- ìŠ¤ì½”ì–´ë§ ê¸°ëŠ¥ ---
        function calculateOwnerScore(owner) {
            const { subscribers, retentionRate, satisfaction, avgCustomerScore } = owner.stats;
            const score = (subscribers * 0.4) + (retentionRate * 3) + (satisfaction * 2) + (avgCustomerScore * 0.1);
            return Math.round(score);
        }

        function showScoreDetailModal() {
            const owner = state.owners[state.loggedInOwner];
            const score = calculateOwnerScore(owner);
            const content = `
                <button class="modal-close" onclick="hideModal('scoreDetailModal')">&times;</button>
                <h3 class="modal-title">êµ¬ë… ìì‚° ìŠ¤ì½”ì–´ ìƒì„¸</h3>
                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="font-size: 48px; font-weight: 700; color: var(--secondary-color);">${score}</div>
                    <p>ìš°ë¦¬ ê°€ê²Œì˜ êµ¬ë… ê²½ìŸë ¥</p>
                </div>
                <div class="card">
                    <p><strong>êµ¬ë…ì ìˆ˜:</strong> ${owner.stats.subscribers}ëª…</p>
                    <p><strong>ê³ ê° ìœ ì§€ìœ¨:</strong> ${owner.stats.retentionRate}%</p>
                    <p><strong>ê³ ê° ë§Œì¡±ë„:</strong> ${owner.stats.satisfaction}%</p>
                    <p><strong>í‰ê·  ë‹¨ê³¨ ì§€ìˆ˜:</strong> ${owner.stats.avgCustomerScore}ì </p>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 12px;" onclick="getAIOperatingTips(this)">âœ¨ AI ìš´ì˜ íŒ ë°›ê¸°</button>
                <button class="btn btn-outline" style="width: 100%;" onclick="getAILoanProposal(this)">ğŸ¦ AI ì‹ ìš© ë¶„ì„ ë° ëŒ€ì¶œ ì œì•ˆ</button>
            `;
            showModal('scoreDetailModal', content, true);
        }
        
        async function getAIOperatingTips(buttonElement) {
            const owner = state.owners[state.loggedInOwner];
            const prompt = `ì €ëŠ” ë¡œì»¬ ê°€ê²Œ êµ¬ë… í”Œë«í¼ì„ ìš´ì˜í•˜ëŠ” '${owner.storeName}'ì˜ ì ì£¼ì…ë‹ˆë‹¤. í˜„ì¬ ì €ì˜ êµ¬ë… ë¹„ì¦ˆë‹ˆìŠ¤ í˜„í™©ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤: êµ¬ë…ì ìˆ˜ ${owner.stats.subscribers}ëª…, ê³ ê° ìœ ì§€ìœ¨ ${owner.stats.retentionRate}%, ê³ ê° ë§Œì¡±ë„ ${owner.stats.satisfaction}%. ì´ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, êµ¬ë…ì ìˆ˜ë¥¼ ëŠ˜ë¦¬ê³  ê³ ê° ë§Œì¡±ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ìš´ì˜ íŒ 2ê°€ì§€ë¥¼ í•œêµ­ì–´ë¡œ ì œì•ˆí•´ì£¼ì„¸ìš”.`;
            const tips = await callGemini(prompt, buttonElement);
            if (tips) {
                const tipContent = `<div class="card" style="background: #374151; margin-top: 16px;"><p style="white-space: pre-wrap;">${tips}</p></div>`;
                buttonElement.insertAdjacentHTML('afterend', tipContent);
            }
        }

        async function getAILoanProposal(buttonElement) {
            const owner = state.owners[state.loggedInOwner];
            const score = calculateOwnerScore(owner);
            const prompt = `ì†Œìƒê³µì¸ ëŒ€ì¶œ ì‹¬ì‚¬ AIì…ë‹ˆë‹¤. ê°€ê²Œ ì´ë¦„ '${owner.storeName}', êµ¬ë… ìì‚° ìŠ¤ì½”ì–´ ${score}ì , ì›” ë§¤ì¶œ ${owner.stats.revenue.toLocaleString()}ì›, ê³ ê° ìœ ì§€ìœ¨ ${owner.stats.retentionRate}% ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, ì´ ê°€ê²Œì˜ ì‹ ìš©ë„ë¥¼ 'ë§¤ìš° ìš°ìˆ˜', 'ìš°ìˆ˜', 'ë³´í†µ', 'ì£¼ì˜' ì¤‘ í•˜ë‚˜ë¡œ í‰ê°€í•˜ê³ , ìµœëŒ€ ëŒ€ì¶œ ê°€ëŠ¥ ê¸ˆì•¡ê³¼ ì—° ì´ììœ¨ì„ í¬í•¨í•œ ê°€ìƒì˜ ì†Œìƒê³µì¸ ëŒ€ì¶œ ìƒí’ˆì„ í•œêµ­ì–´ë¡œ ì œì•ˆí•´ì£¼ì„¸ìš”.`;
            const proposal = await callGemini(prompt, buttonElement);
            if (proposal) {
                const proposalContent = `<div class="card" style="background: #374151; margin-top: 16px;"><p style="white-space: pre-wrap;">${proposal}</p></div>`;
                buttonElement.insertAdjacentHTML('afterend', proposalContent);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderAuthLinks();
            renderCurrentPage();
        });
    </script>
</body>
</html>
